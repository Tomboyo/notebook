#!/bin/bash

set -eo pipefail

BASEDIR=$(realpath $(dirname "$0"))
BINDIR="$BASEDIR/bin"

CLEAN=""
SERVE=""
while [[ $# -gt 0 ]] ; do
    key="$1"
    case $key in
        --clean)
            CLEAN="true"
            shift
            ;;
        -s|--serve)
            SERVE="true"
            shift
            ;;
        *)
            echo "unexpected argument $1"
            exit 1
            ;;
    esac
done

if [[ $CLEAN == "true" ]] ; then
    echo "CLEAN $BASEDIR/target..."

    rm -rf "$BASEDIR/target"
fi

echo "BUILD..."
if [[ ! -d ./target/pre ]] ; then
    mkdir -p target/pre
fi
cp src/adoc/*.adoc target/pre
echo "PRECOMPILE..."
bin/precompile
echo "COMPILE..."
find target/pre -type f -exec \
    asciidoctor -r asciidoctor-diagram -D target {} ';'

if [[ $SERVE == "true" ]] ; then
    echo "SERVE..."
    "$BINDIR/serve"
fi
